# Required environment variables:
# COMFYUI_PATH=<master_folder>

# Optional environment variables
# COMFYUI_GPU_DEVICE_ID=<gpu_device_id>
# COMFYUI_PORT=<port_number>
# COMPOSE_PROFILES=kjnodes  # to enable KJNodes init container

version: "3.9"

services:
  comfyui_init_qwentts:
    profiles: [qwentts]
    image: alpine:3.20
    container_name: comfyui_init_qwentts
    restart: "no"
    volumes:
      - ${COMFYUI_PATH}/custom_nodes:/custom_nodes
    command:
      - /bin/sh
      - -c
      - |
        set -e
        apk add --no-cache git

        echo ">>> Installing Qwen-TTS"

        if [ ! -d /custom_nodes/ComfyUI-Qwen-TTS ]; then
          git clone https://github.com/flybirdxx/ComfyUI-Qwen-TTS.git /custom_nodes/ComfyUI-Qwen-TTS
          echo ">>> Qwen-TTS cloned"
        else
          echo ">>> Qwen-TTS already present, updating"
          cd /custom_nodes/ComfyUI-Qwen-TTS
          git pull --ff-only || true
        fi

        echo ">>> Init container finished"

  comfyui_init_kjnodes:
    profiles: [kjnodes]
    image: alpine:3.20
    container_name: comfyui_init_kjnodes
    restart: "no"
    volumes:
      - ${COMFYUI_PATH}/custom_nodes:/custom_nodes
    command:
      - /bin/sh
      - -c
      - |
        set -e

        echo ">>> Installing ComfyUI-KJNodes"

        apk add --no-cache git

        if [ ! -d /custom_nodes/ComfyUI-KJNodes ]; then
          git clone https://github.com/kijai/ComfyUI-KJNodes.git /custom_nodes/ComfyUI-KJNodes
          echo ">>> KJNodes cloned"
        else
          echo ">>> KJNodes already present, updating"
          cd /custom_nodes/ComfyUI-KJNodes
          git pull --ff-only || true
        fi

        echo ">>> Init container finished"

  comfyui:
    image: ghcr.io/dam-pav/comfyui:latest
    container_name: comfyui_gpu${COMFYUI_GPU_DEVICE_ID:-0}
    runtime: nvidia
    labels:
      - "com.centurylinklabs.watchtower.enable=${WATCHTOWER:-false}"
      - "${CUSTOM_LABEL:-foo=bar}"
    gpus:
      - device_ids: ["${COMFYUI_GPU_DEVICE_ID:-0}"]
        capabilities: ["gpu"]

    environment:
      TZ: Europe/Ljubljana
      NVIDIA_DRIVER_CAPABILITIES: "compute,utility"

    command:
      - /bin/bash
      - -c
      - |
        set -e

        . /opt/ComfyUI/venv/bin/activate
        pip install --no-cache-dir --upgrade pip

        echo ">>> Installing custom node requirements"
        for dir in /opt/ComfyUI/custom_nodes/*; do
          if [ -f "$dir/requirements.txt" ]; then
            echo ">>> Installing requirements from $dir"
            pip install --no-cache-dir -r "$dir/requirements.txt"
          fi
        done

        echo ">>> Checking for Qwen-TTS node"

        if [ -d "/opt/ComfyUI/custom_nodes/ComfyUI-Qwen-TTS" ]; then
          echo ">>> Qwen-TTS detected — enforcing audio + HF deps"

          pip install --no-cache-dir --upgrade \
            transformers==4.57.3 \
            librosa \
            sox \
            onnxruntime \
            accelerate

          echo ">>> Installed versions:"
          pip show transformers | grep Version
          pip show librosa | grep Version
          pip show sox | grep Version
          pip show onnxruntime | grep Version
          pip show accelerate | grep Version
        else
          echo ">>> Qwen-TTS not present — skipping audio + HF deps override"
        fi

        exec python main.py \
          --listen 0.0.0.0 \
          --port 8188 \
          --disable-async-offload \
          --enable-cors-header "*"

    volumes:
      - ${COMFYUI_PATH}/user:/opt/ComfyUI/user
      - ${COMFYUI_PATH}/custom_nodes:/opt/ComfyUI/custom_nodes
      - ${COMFYUI_PATH}/models:/opt/ComfyUI/models
      - ${COMFYUI_PATH}/input:/opt/ComfyUI/input
      - ${COMFYUI_PATH}/output:/opt/ComfyUI/output

    ports:
      - "${COMFYUI_PORT:-8188}:8188"

    restart: unless-stopped
